name: build-and-push
on:
  push:
    branches: [ main ]
    paths:
      - "app/**"
      - ".github/workflows/build.yml"

env:
  first_etl_image: "first_etl_image"


jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    # ▸ publica la salida del job
    outputs:
      first_etl_image: ${{ steps.build_first_etl_image.outputs.image_tag }}
      

    steps:
    - uses: actions/checkout@v4

    # 1 ▸ Login OIDC
    - id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

    # 2 ▸ Instalar gcloud + helper Docker
    - uses: google-github-actions/setup-gcloud@v1
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ secrets.GAR_LOCATION }}-docker.pkg.dev --quiet

    # 3 ▸ Build & Push ──── id: build_push de las dos back y front
    - name: Build and push backend image
      id: build_backend
      run: | 
        TAG=${{ github.sha }}
        IMAGE=${{ secrets.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/${{ secrets.GAR_REPOSITORY }}/${{ env.FIRST_ETL_IMAGE }}:$TAG

        echo "🏗️  Construyendo $IMAGE" 
        docker build -t "$IMAGE" ./app/backend
        docker push "$IMAGE"

        echo "image_tag=$TAG" >> "$GITHUB_OUTPUT"